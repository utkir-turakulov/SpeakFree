@model SpeakFree.API.Models.ChatViewModel
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
}

<!-- Secondary sidebar -->
<div class="sidebar sidebar-light sidebar-secondary sidebar-expand-md">
    <!-- Sidebar mobile toggler -->
    <div class="sidebar-mobile-toggler text-center">
        <a href="#" class="sidebar-mobile-secondary-toggle">
            <i class="icon-arrow-left8"></i>
        </a>
        <span class="font-weight-semibold">Secondary sidebar</span>
        <a href="#" class="sidebar-mobile-expand">
            <i class="icon-screen-full"></i>
            <i class="icon-screen-normal"></i>
        </a>
    </div>
    <!-- /sidebar mobile toggler -->
    <!-- Sidebar content -->
    <div class="sidebar-content">
        <!-- Contacts -->
        <div class="card">
            <div class="card-header bg-transparent header-elements-inline">
                <span class="text-uppercase font-size-sm font-weight-semibold">Контакты</span>
                <div class="header-elements">
                    <div class="list-icons">
                        <a class="list-icons-item" data-action="collapse"></a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form action="#">
                    <div class="form-group-feedback form-group-feedback-right">
                        <input type="search" class="form-control" placeholder="Введите имя пользователя... ">
                        <div class="form-control-feedback">
                            <i class="icon-search4 font-size-base text-muted"></i>
                        </div>
                    </div>
                </form>
            </div>
            <div class="card-body">
                <ul class="media-list">
                    <li class="media">
                        <a href="#" class="mr-3 position-relative">
                            <img src="../../../../global_assets/images/placeholders/placeholder.jpg" width="36" height="36" class="rounded-circle" alt="">
                            <span class="badge badge-info badge-pill badge-float border-2 border-white">6</span>
                        </a>
                        <div class="media-body">
                            <div class="font-weight-semibold">Rebecca Jameson</div>
                            <span class="font-size-sm text-muted">Web developer</span>
                        </div>
                        <div class="ml-3 align-self-center">
                            <div class="dropdown">
                                <a href="#" class="text-default dropdown-toggle caret-0" data-toggle="dropdown" aria-expanded="false"><i class="icon-more2"></i></a>
                                <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; transform: translate3d(-164px, 17px, 0px); top: 0px; left: 0px; will-change: transform;">
                                    <a href="#" class="dropdown-item"><i class="icon-comment-discussion"></i>Начать беседу</a>
                                    <!--<a href="#" class="dropdown-item"><i class="icon-phone2"></i> Make a call</a>
                            <a href="#" class="dropdown-item"><i class="icon-mail5"></i> Send mail</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="icon-statistics"></i> Statistics</a>-->
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="media">
                        <a href="#" class="mr-3 position-relative">
                            <img src="../../../../global_assets/images/placeholders/placeholder.jpg" width="36" height="36" class="rounded-circle" alt="">
                            <span class="badge badge-info badge-pill badge-float border-2 border-white">9</span>
                        </a>
                        <div class="media-body">
                            <div class="font-weight-semibold">Walter Sommers</div>
                            <span class="font-size-sm text-muted">Lead developer</span>
                        </div>
                        <div class="ml-3 align-self-center">
                            <div class="dropdown">
                                <a href="#" class="text-default dropdown-toggle caret-0" data-toggle="dropdown"><i class="icon-more2"></i></a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item"><i class="icon-comment-discussion"></i>Начать беседу</a>
                                    <!--<a href="#" class="dropdown-item"><i class="icon-phone2"></i> Make a call</a>
                            <a href="#" class="dropdown-item"><i class="icon-mail5"></i> Send mail</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="icon-statistics"></i> Statistics</a>-->
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="media">
                        <a href="#" class="mr-3">
                            <img src="../../../../global_assets/images/placeholders/placeholder.jpg" width="36" height="36" class="rounded-circle" alt="">
                        </a>
                        <div class="media-body">
                            <div class="font-weight-semibold">Otto Gerwald</div>
                            <span class="font-size-sm text-muted">Front end developer</span>
                        </div>
                        <div class="ml-3 align-self-center">
                            <div class="dropdown">
                                <a href="#" class="text-default dropdown-toggle caret-0" data-toggle="dropdown"><i class="icon-more2"></i></a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item"><i class="icon-comment-discussion"></i>Начать беседу</a>
                                    <!--<a href="#" class="dropdown-item"><i class="icon-phone2"></i> Make a call</a>
                            <a href="#" class="dropdown-item"><i class="icon-mail5"></i> Send mail</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="icon-statistics"></i> Statistics</a>-->
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="media">
                        <a href="#" class="mr-3">
                            <img src="../../../../global_assets/images/placeholders/placeholder.jpg" width="36" height="36" class="rounded-circle" alt="">
                        </a>
                        <div class="media-body">
                            <div class="font-weight-semibold">Vince Satmann</div>
                            <span class="font-size-sm text-muted">UX expert</span>
                        </div>
                        <div class="ml-3 align-self-center">
                            <div class="dropdown">
                                <a href="#" class="text-default dropdown-toggle caret-0" data-toggle="dropdown"><i class="icon-more2"></i></a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item"><i class="icon-comment-discussion"></i>Начать беседу</a>
                                    <!--<a href="#" class="dropdown-item"><i class="icon-phone2"></i> Make a call</a>
                            <a href="#" class="dropdown-item"><i class="icon-mail5"></i> Send mail</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="icon-statistics"></i> Statistics</a>-->
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="media">
                        <a href="#" class="mr-3">
                            <img src="../../../../global_assets/images/placeholders/placeholder.jpg" width="36" height="36" class="rounded-circle" alt="">
                        </a>
                        <div class="media-body">
                            <div class="font-weight-semibold">Jason Leroy</div>
                            <span class="font-size-sm text-muted">SEO specialist</span>
                        </div>
                        <div class="ml-3 align-self-center">
                            <div class="dropdown">
                                <a href="#" class="text-default dropdown-toggle caret-0" data-toggle="dropdown"><i class="icon-more2"></i></a>
                                <div class="dropdown-menu dropdown-menu-right">
                                    <a href="#" class="dropdown-item"><i class="icon-comment-discussion"></i>Начать беседу</a>
                                    <!--<a href="#" class="dropdown-item"><i class="icon-phone2"></i> Make a call</a>
                            <a href="#" class="dropdown-item"><i class="icon-mail5"></i> Send mail</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item"><i class="icon-statistics"></i> Statistics</a>-->
                                </div>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
        <!-- /contacts -->
    </div>
    <!-- /sidebar content -->
</div>
<!-- /secondary sidebar -->
<div class="content-wrapper">

    <div class="page-header page-header-light">
        <div class="page-header-content header-elements-md-inline">
            <div class="page-title d-flex">
                <h4><i class="icon-arrow-left52 mr-2"></i> <span class="font-weight-semibold">Чат</span></h4>
                <a href="#" class="header-elements-toggle text-default d-md-none"><i class="icon-more"></i></a>

                <!--<a href="#" class="navbar-nav-link sidebar-control sidebar-secondary-toggle d-none d-md-block">
                    <i class="icon-transmission"></i>
                </a>Раскрытие списка контактов-->
            </div>
        </div>
    </div>
    <div class="content">
        <!-- Line content divider -->
        <div class="card">
            <div class="card-header header-elements-inline">
                <h5 class="card-title"></h5>
                <div class="header-elements">
                    <div class="list-icons">
                        <a class="list-icons-item" data-action="collapse"></a>
                        <a class="list-icons-item" data-action="reload"></a>
                        <a class="list-icons-item" data-action="remove"></a>
                    </div>
                </div>
            </div>
            <input type="text" hidden id="userInput" value="@Model.User.Name" />
            <div class="card-body">
                <ul class="media-list media-chat media-chat-scrollable mb-3" id="messagesList">
                    <!--  <li class="media">
                        <div class="mr-3">
                            <a href="~/lib/limitless/global_assets/images/placeholders/placeholder.jpg">
                                <img src="~/lib/limitless/global_assets/images/placeholders/placeholder.jpg" class="rounded-circle" width="40" height="40" alt="">
                            </a>
                        </div>
                        <div class="media-body">
                            <div class="media-chat-item">Crud reran and while much withdrew ardent much crab hugely met dizzily that more jeez gent equivalent unsafely far one hesitant so therefore.</div>
                            <div class="font-size-sm text-muted mt-2">Tue, 10:28 am <a href="#"><i class="icon-pin-alt ml-2 text-muted"></i></a></div>
                        </div>
                    </li>
                    <li class="media media-chat-item-reverse">
                        <div class="media-body">
                            <div class="media-chat-item">Thus superb the tapir the wallaby blank frog execrably much since dalmatian by in hot. Uninspiringly arose mounted stared one curt safe</div>
                            <div class="font-size-sm text-muted mt-2">Tue, 8:12 am <a href="#"><i class="icon-pin-alt ml-2 text-muted"></i></a></div>
                        </div>
                        <div class="ml-3">
                            <a href="~/lib/limitless/global_assets/images/placeholders/placeholder.jpg">
                                <img src="~/lib/limitless/global_assets/images/placeholders/placeholder.jpg" class="rounded-circle" width="40" height="40" alt="">
                            </a>
                        </div>
                    </li>-->
                </ul>
                <textarea name="enter-message" class="form-control mb-3" rows="3" cols="1" placeholder="Введите текст сообщения..." id="messageInput"></textarea>
                <div class="d-flex align-items-center">
                    <!--<div class="list-icons list-icons-extended">
                        <a href="#" class="list-icons-item" data-popup="tooltip" data-container="body" title="Send photo"><i class="icon-file-picture"></i></a>
                        <a href="#" class="list-icons-item" data-popup="tooltip" data-container="body" title="Send video"><i class="icon-file-video"></i></a>
                        <a href="#" class="list-icons-item" data-popup="tooltip" data-container="body" title="Send file"><i class="icon-file-plus"></i></a>
                    </div> TODO Отправка контента-->
                    <button type="button" class="btn bg-teal-400 btn-labeled btn-labeled-right ml-auto" id="sendButton"><b><i class="icon-paperplane"></i></b> Отправить</button>
                </div>
            </div>
        </div>
    </div>
    @await Html.PartialAsync("_FooterPartial")
</div>


<script>
    let hubUrl = 'http://localhost:44324/chatter';
    const hubConnection = new signalR.HubConnectionBuilder()
        .withUrl(hubUrl, { transport: signalR.HttpTransportType.WebSockets | signalR.HttpTransportType.LongPolling })
        .configureLogging(signalR.LogLevel.Information)
        .build();
    let userName = '';
    "use strict";

    var connection = new signalR.HubConnectionBuilder().withUrl("/chatter").build();

    //Disable send button until connection is established
    document.getElementById("sendButton").disabled = true;

    /*<li class="media">
        <div class="mr-3">
            <a href="~/lib/limitless/global_assets/images/placeholders/placeholder.jpg">
                <img src="~/lib/limitless/global_assets/images/placeholders/placeholder.jpg" class="rounded-circle" width="40" height="40" alt="">
                    </a>
                </div>
            <div class="media-body">
                <div class="media-chat-item">Crud reran and while much withdrew ardent much crab hugely met dizzily that more jeez gent equivalent unsafely far one hesitant so therefore.</div>
                <div class="font-size-sm text-muted mt-2">Tue, 10:28 am <a href="#"><i class="icon-pin-alt ml-2 text-muted"></i></a></div>
            </div>
            </li>*/

    connection.on("ReceiveMessage", function (user, message) {
        var msg = message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        var encodedMsg = user + " says " + msg;
        var li = document.createElement("li");
        li.classList.add('media');
        var divContent = document.createElement("div");
        $(divContent).attr('class', 'mr-3');
        divContent.textContent = user;

        var contentLink = document.createElement("a");
        $(contentLink).attr('href', '/lib/limitless/global_assets/images/placeholders/placeholder.jpg');
        var image = document.createElement("img");
        $(image).attr('src', '/lib/limitless/global_assets/images/placeholders/placeholder.jpg');
        $(image).attr('class', 'rounded-circle');
        $(image).attr('width', '40');
        $(image).attr('height', '40');


        var mediaBody = document.createElement("div");
        $(mediaBody).attr('class', 'media-body');

        var mediaChatItem = document.createElement("div");
        $(mediaChatItem).attr('class', 'media-chat-item');

        var mediaTime = document.createElement("div");
        $(mediaTime).attr('class', 'font-size-sm text-muted mt-2');

        contentLink.appendChild(image);
        divContent.appendChild(contentLink);

        mediaChatItem.textContent = msg;
        mediaBody.appendChild(mediaChatItem);

        let current_datetime = new Date();
        let formatted_date = current_datetime.getFullYear() + "-"
            + (current_datetime.getMonth() + 1) + "-"
            + current_datetime.getDate() +
            " " + current_datetime.getHours() + ":"
            + current_datetime.getMinutes()
            + ":" + current_datetime.getSeconds();

        mediaTime.textContent = formatted_date;
        mediaBody.appendChild(mediaTime);
        li.appendChild(divContent);
        li.appendChild(mediaBody);

        document.getElementById("messagesList").appendChild(li);
    });

    connection.start().then(function () {
        document.getElementById("sendButton").disabled = false;
    }).catch(function (err) {
        return console.error(err.toString());
    });

    document.getElementById("sendButton").addEventListener("click", function (event) {
        var user = document.getElementById("userInput").value;
        var message = document.getElementById("messageInput").value;
        connection.invoke("SendMessage", user, message).catch(function (err) {
            return console.error(err.toString());
        });
        event.preventDefault();
    });
</script>